name: Kustomize Check

on: 
  push: {}
  pull_request:
    branches:
      - main

jobs:
  kustomize-build-check:
    runs-on: ubuntu-latest
    container:
      # Use the same version of kustomize available with Argo
      image: nekottyo/kustomize-kubeval:kustomizev4
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Validate all kustomization.yaml files
        run: |
          #!/bin/bash
          set -e

          echo "Kustomize Version:"
          kustomize version
          echo ""

          find -type f -iname "kustomization.y*ml" | while read file
          do
              dir=$(dirname "$file")
              echo "Testing ${dir}"
              kustomize build "${dir}"
              echo "---------------------------"
          done